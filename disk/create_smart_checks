#!/bin/bash

# INFO
# This script creates a scron script that runs a short test all disks
# each week and sets up a nagios test for each drive.
# Run every time you change your harddrives.

CONF="/etc/nrpe.d/disk.cfg"
CRON="/etc/cron.d/disk"

cat <<EOF > $CRON
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=samuel@dalesjo.net

# DO NOT EDIT THIS FILE
# This file is automaticly generated by create_smart_checks
#
#
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  *        user-name       command to be executed
EOF


cat <<EOF > $CONF
# DO NOT EDIT THIS FILE
# This file is automaticly generated by create_smart_checks
EOF

DRIVES=`lsblk --nodeps -n -o name`
W=0
for DRIVE in $DRIVES; do
  ID=`udevadm info --query=property --name=/dev/$DRIVE | grep -P "ID_SERIAL\=|ID_BUS\=" | sort | head -n2 | cut --delimiter="=" --fields=2 | paste -sd "-" -`
  TEST="/usr/lib64/nagios/plugins/check_ide_smart -d /dev/disk/by-id/$ID"

  echo "command[disk_smart_$ID]=$TEST" >> $CONF
  echo "  10 5  *  *  $W        root            chronic smartctl -t short /dev/disk/by-id/$ID" >> $CRON

  echo "Disk: $ID"
  echo "disk_smart_$ID"
  echo ""

  W=$((W + 1))
  if [ "$W" -ge "6" ]; then
    W=0
  fi;
done

systemctl restart nrpe.service
